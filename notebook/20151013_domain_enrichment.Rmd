---
title: "Domain enrichment"
author: "HÃ©ctor Climente"
date: "10/13/2015"
output:
  html_document:
    toc: true
---

```{r environment, include=FALSE }
source("~/SmartAS/Pipeline/scripts/variablesAndFunctions.r")
library(knitr)
library(DT)
results_filepath <- paste0(workingDir,"/structural_analysis/")
wd <- paste0("~/SmartAS/Pipeline/notebook/20151013_domain_enrichment_files/data/")
```

```{r get_files, include=FALSE }
dir.create(wd,recursive=T)

file.copy(paste0(workingDir,"/mutations/feature_enrichment.txt"),wd,overwrite = T)
file.copy(paste0(workingDir,"/Data/Databases/prosite2go.clean.txt"),wd,overwrite = T)
file.copy(paste0(workingDir,"/Data/Databases/Pfam2go.clean.txt"),wd,overwrite = T)
file.copy(paste0(results_filepath,"structural_features.onlyModels.tsv"),wd,overwrite = T)
file.copy(paste0(workingDir,"/switches/tables/candidateList_allCancers_models_notNoise.txt"),wd,overwrite = T)

```

We want to see which domains are being specially affected by the switches.

# Naive analysis

```{r features_enriched_naive }

feat_enrich <- read.delim(paste0(wd,'feature_enrichment.txt'), header=TRUE)

feat_enrich_agg <- ddply(feat_enrich,.(Domain), summarise, 
                        MutIn=sum(MutIn), AllMuts=sum(AllMuts),
                        SwitchesIn=sum(SwitchesIn), AllSwitches=sum(AllSwitches),
                        DomainCount=sum(DomainCount),AllDomains=sum(AllDomains))
feat_enrich_agg$MutFreq <- feat_enrich_agg$MutIn/feat_enrich_agg$AllMuts
feat_enrich_agg$SwitchFreq <- feat_enrich_agg$SwitchesIn/feat_enrich_agg$AllSwitches
feat_enrich_agg$DomainFrequency <- feat_enrich_agg$DomainCount/feat_enrich_agg$AllDomains

feat_enrich_agg <- feat_enrich_agg[feat_enrich_agg$DomainFrequency!=0,]
feat_enrich_agg$FC <- feat_enrich_agg$SwitchFreq/feat_enrich_agg$DomainFrequency

feat_enrich_agg$p <- apply(feat_enrich_agg[,c("SwitchesIn","AllSwitches","DomainFrequency")],1, function(x){ 
  p <- binom.test(x[1],x[2],x[3],"greater")
  p$p.value
} )
feat_enrich_agg$adjp <- p.adjust(feat_enrich_agg$p)

# plot the significant features and the number of times they are gained or lost
# read candidates and features changed
candidatesDf_agg <- read.delim(paste0(wd,"candidateList_allCancers_models_notNoise.txt"))
structural_features <- read.delim(paste0(wd,"structural_features.onlyModels.tsv"))

# filterout non-changing features, and random results
nrStructural_features <- structural_features[structural_features$Random == "NonRandom",]
nrStructural_features <- nrStructural_features[nrStructural_features$WhatsHappenning != "Nothing",]

# merge with significantly changed features and with candidate info
nrStructural_features <- merge(nrStructural_features,subset(feat_enrich_agg, adjp < 0.05),by.x="Feature",by.y="Domain")
nrStructural_features <- merge(nrStructural_features,candidatesDf_agg,by.x=c("Gene","nTx","tTx"),by.y=c("GeneId","Normal_transcript","Tumor_transcript"))

# sum total instances of gain and loss
df <- ddply(nrStructural_features,.(Feature,FC,adjp),summarise,Losses=sum(PatientNumber*as.numeric(WhatsHappenning=="Lost_in_tumor")),Gains=sum(PatientNumber*as.numeric(WhatsHappenning=="Gained_in_tumor")))

# volcano plot
df.cp <- df
df.cp$adjp[df.cp$adjp == 0] <- 1e-320
df.cp$Sign <- ifelse(df.cp$Losses > df.cp$Gains, "Loss", "Gain")

ggplot(df.cp,aes(FC,-log10(adjp),color=Sign,size=sqrt(Losses+Gains))) + 
  geom_point() +
  smartas_theme() +
  xlab("Fold change") +
  scale_color_manual(values=c("#d95f02","#7570b3"))

# display stuff
df <- df[order(-df$FC),]
df$FC <- round(df$FC,2)
df$adjp <- format(df$adjp,digits=3)

df$Feature <- gsub("|"," - ",df$Feature,fixed = T)
df$Feature <- gsub("_"," ",df$Feature,fixed = T)

datatable(df)

```

The table above shows the features with an adjusted p-value of 0.05. Out of 5327 features affected by the switches, 462 of them (8.7%) are overrepresented. The median fold-change (frequency of the change/frequency of the domain) is quite high, of around 5. The Losses/Gains columns represent the number of times that feature is being gained in tumor or lost.

Some interesting things:

* [Lack of expression of SARA domain is related to EMT](http://www.ncbi.nlm.nih.gov/pubmed/19620243).

* Loss of Mitochondria Localisation Sequence is intriguing. What happens to those proteins?

```{r switches_affecting_domains }

# create two groups
# Group 1: switches that gain/lose at least one of the significantly enriched domains
# Group 2: all the other switches
x <- unique(nrStructural_features[,c("Gene","nTx","tTx")])
colnames(x) <- c("GeneId","Normal_transcript","Tumor_transcript")
y <- candidatesDf_agg[! candidatesDf_agg$GeneId %in% x$GeneId &
                      ! candidatesDf_agg$Normal_transcript %in% x$Normal_transcript &
                      ! candidatesDf_agg$Tumor_transcript %in% x$Tumor_transcript &
                        as.logical(candidatesDf_agg$IsRelevant),
                      c("GeneId","Normal_transcript","Tumor_transcript")]

studyGroups(x,y,candidatesDf_agg)

```

We created two sets of switches: the first one involves thea gain/loss of a domain significantly enriched; the second one involves any functional switch that does not involve it. We see how the switches that involve one of those domains tend to affect more patients and cancer types. Also there is a non-significant enrichment in driver genes in the first group.

```{r feature_annotation_1 }

prosite_annotation <- read.delim(paste0(wd,"prosite2go.clean.txt"),row.names = NULL,header=F)
pfam_annotation <- read.delim(paste0(wd,"Pfam2go.clean.txt"),row.names = NULL,header=F)

annotation <- rbind(prosite_annotation,pfam_annotation)
colnames(annotation) <- c("id","annotation")

# remove the GO prefix from all of them  
z <- gsub(";GO:[[:digit:]]+", "", annotation$annotation)
z <- gsub("^GO:", "", z)
z <- gsub("_", " ", z)
z <- paste0(toupper(substring(z, 1,1)),substring(z, 2))

annotation$GOid <- unlist(strsplit(as.character(annotation$annotation),";",fixed = T))[c(F,T)]
annotation$GO <- z

annotation <- annotation[,colnames(annotation) != "annotation"]

# annotate domains
df$id <- unlist(strsplit(df$Feature," - "))[c(T,F)]
df.go <- merge(df,annotation)

# annotation frequency
freqFunctions <- as.data.frame(table(df.go$GO))
colnames(freqFunctions) <- c("GO","Frequency")
freqFunctions <- freqFunctions[order(-freqFunctions$Frequency),]
row.names(freqFunctions) <- NULL 

datatable(freqFunctions)

```

These functions are too generic right now to be really informative. It would be necessary to divide the different kinds of annotations (molecular function, cell compartment and biological process). However, from a first look it seems that there are several domains involved in transcription.

# Categorized analysis

```{r features_enriched_byType, results='asis', cache=TRUE }

structural_features <- read.delim(paste0(wd,"structural_features.onlyModels.tsv"))
nrStructural_features <- structural_features[structural_features$Random == "NonRandom",]

for (featureType in c('Pfam','prosite')){
  
  annotation <- read.delim(paste0(workingDir,"/Data/Databases/",featureType,"2go.clean.txt"),row.names = NULL,header=F)
  colnames(annotation) <- c("id","GO")
  
  z <- gsub(";GO:[[:digit:]]+", "", annotation$GO)
  z <- gsub("^GO:", "", z)
  z <- paste0(toupper(substring(z, 1,1)),substring(z, 2))
  
  annotation$GO <- z
    
  for (action in c("Lost_in_tumor","Gained_in_tumor")){
    uniqStuff <- unique( nrStructural_features$Feature[nrStructural_features$Analysis==featureType & nrStructural_features$WhatsHappenning!="Nothing" & nrStructural_features$WhatsHappenning==action] )
    actionTag <- tolower(unlist(strsplit(action,split = " "))[1])
    
    for ( geneset in c("oncogene",'suppressor',"driver")){
      
      cat(paste(featureType,geneset,action,sep=" "))
      
      affectedFeats <- list()
      
      for (feat in uniqStuff){
        
        usedFeature <- nrStructural_features[nrStructural_features$WhatsHappenning==action & nrStructural_features$Feature==feat,]
        nonUsedFeature <- nrStructural_features[nrStructural_features$WhatsHappenning==action | nrStructural_features$Feature!=feat,]
        
        if (geneset=="driver"){
          FG=sum(usedFeature$Driver==1)
          FNG=sum(usedFeature$Driver==0)
          NFG=sum(nonUsedFeature$Driver==1)
          NFNG=sum(nonUsedFeature$Driver==0)
        } else {
          FG=sum(usedFeature$DriverType==geneset)
          FNG=sum(usedFeature$DriverType!=geneset)
          NFG=sum(nonUsedFeature$DriverType==geneset)
          NFNG=sum(nonUsedFeature$DriverType!=geneset)
        }
        
        affectedFeats[[feat]] <- data.frame(Feature=feat, WhatsHappenning=action,
                                            FG=FG,FNG=FNG,NFG=NFG,NFNG=NFNG)
      }
      
      affectedFeatsDf <- do.call('rbind',affectedFeats)
      
      affectedFeatsDf$p <- apply(affectedFeatsDf,1, function(x){ 
        k <- fisher.test(x=matrix(as.numeric(x[3:6]),nrow=2,ncol=2),alternative="greater")
        k$p.value } )
      affectedFeatsDf$p.adj <- p.adjust(affectedFeatsDf$p)
      affectedFeatsDf <- affectedFeatsDf[order(affectedFeatsDf$p),]
      kk <- merge(affectedFeatsDf,annotation,all.x=T)
      
      # prepare colums for print
      df <- affectedFeatsDf[,c("Feature","p","p.adj")]
      
      df$Feature <- gsub("|"," - ",df$Feature,fixed = T)
      df$Feature <- gsub("_"," ",df$Feature,fixed = T)
      
      df$p.adj <- format(df$p.adj,scientific=TRUE)
      df$p <- format(df$p,scientific=TRUE)
      
      print(kable(head(df,n=10),row.names=FALSE))
      
      write.table(affectedFeatsDf,file=paste(results_filepath,"tables",paste(featureType,actionTag,paste0(geneset,".tsv"),sep="_"),sep="/"),sep="\t", row.names=F, quote=F)
      
      # plot the significant groups
      affectedFeatsDf_s <- affectedFeatsDf[affectedFeatsDf$p.adj < 0.05,]
      
      if (nrow(affectedFeatsDf_s)==0){
        next
      }
      
      affectedFeatsDf_s$id <- unlist(strsplit(as.character(affectedFeatsDf_s$Feature),"|",fixed=T))[c(T,F)]
      affectedFeatsDf_s <- merge(affectedFeatsDf_s,annotation,all.x=T)
      
      annotationCount <- sort(table(as.character(affectedFeatsDf_s$GO)),decreasing=T)
      topGroups <- names(head(annotationCount[annotationCount > 1],4))
      
      plotAnnotatedFeats <- ddply(affectedFeatsDf_s,.(id,Feature,p.adj),function(y){ 
        x <- intersect(y$GO,topGroups)
        if (length(x) > 0){names(sort(-annotationCount[x])[1])} else {"Other"}})
      plotAnnotatedFeats$Annotation <- plotAnnotatedFeats$V1
      plotAnnotatedFeats$log_p <- -log10(plotAnnotatedFeats$p.adj)
      
      plotAnnotatedFeats <- plotAnnotatedFeats[order(-plotAnnotatedFeats$log_p,plotAnnotatedFeats$Feature),]
      plotAnnotatedFeats$Feature <- gsub("_"," ",unlist(strsplit(as.character(plotAnnotatedFeats$Feature),"|",fixed=T))[c(F,T)])
      
      plotAnnotatedFeats$Feature <- splitTextInLines(plotAnnotatedFeats$Feature)
      plotAnnotatedFeats$Feature <- factor(plotAnnotatedFeats$Feature,levels=as.factor(plotAnnotatedFeats$Feature))
      plotAnnotatedFeats$Annotation <- factor(plotAnnotatedFeats$Annotation,levels=as.factor(c(topGroups,"Other")))
      
      annotationPalette <- c("#d7191c","#fdae61","#ffffbf","#abdda4","#2b83ba")
      names(annotationPalette) <- c(topGroups,"Other")
      
      p <- ggplot(plotAnnotatedFeats,aes(x=Feature,y=log_p,fill=Annotation)) + 
        geom_bar(stat="identity",position="dodge") + 
        smartas_theme() + 
        scale_fill_manual(values=annotationPalette) + 
        xlab(paste0(featureType," features")) + ylab("-log10(adjusted p)") + 
        facet_wrap(~Annotation,drop=TRUE,scale="free_x") + 
        theme(axis.text.x=element_text(size=7,angle=90,hjust=1,vjust=0.5,colour="black"))
      ggsave(paste0(results_filepath,"figures/",paste(featureType,actionTag,paste0(geneset,".png"),sep="_")),p)
      
      print(p)
      
    }
  }
}
```
