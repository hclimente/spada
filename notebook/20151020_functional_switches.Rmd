---
title: "Functional switches analysis"
author: "HÃ©ctor Climente"
date: "10/20/2015"
output: html_document
---

```{r environment, include=FALSE }
source("~/SmartAS/Pipeline/scripts/variablesAndFunctions.r")
library(knitr)
library(DT)
library(venneuler)
library(limma)
results_filepath <- paste0(workingDir,"/structural_analysis/")
wd <- paste0("~/SmartAS/Pipeline/notebook/20151020_functional_switches/data/")
```

```{r get_files, include=FALSE }
dir.create(wd,recursive=T)

file.copy(paste0(results_filepath,"structural_features.onlyModels.tsv"),wd,overwrite = T)
file.copy(Sys.glob(paste0(results_filepath,"*structural_summary.tsv")),wd,overwrite = T)

```

# Overview

## Study the changing functional feature

```{r study_functional_switches-1, out.width='2000px', out.height='2000px'}

ssList <- list()
for (tumor in cancerTypes){
  cancer.structuralSummary <- read.delim(paste0(wd,tumor,".structural_summary.tsv"),row.names=NULL)
  cancer.structuralSummary$Tumor <- tumor
  
  for (f in c("iLoops","Domain","Disorder","Anchor","PTM")){
    col <- cancer.structuralSummary[,colnames(cancer.structuralSummary)==f]
    cancer.structuralSummary[,colnames(cancer.structuralSummary)==f] <- col == "True"
  }
  
  colnames(cancer.structuralSummary) <- c("Gene","Symbol","NormalTranscript","TumorTranscript","iLoops","Pfam","IUPRED","ANCHOR","ProSite","Tumor")
  
  ssList[[tumor]] <- cancer.structuralSummary
}

structuralSummary <- do.call("rbind",ssList)

x <- structuralSummary[,c("iLoops","Pfam","IUPRED","ANCHOR","ProSite")]
colnames(x) <- paste(c("ArchDB","Pfam","IUPRED","ANCHOR","ProSite"),colSums(x), sep=": ")
a <- venneuler(x)

plot(a)

```

The diagram shows the type of the affeted features in the functional switches from all tumor types. The main feature affected are disordered regions, a large fraction of which might be involved in interactions. The intersection between ANCHOR and IUPRED does not extend to all ANCHOR changes. This is surprising, given that ANCHOR uses IUPRED to find disordered regions before looking for ancoring sequences in them.

Changes in ArchDB loops are the second most numerous group (11552). Out of them, 2313 switches exclusively exhibit a change in loops. Because we do not plan to work with loops, maybe we should consider excluding them from the analysis in later stages.

ProSite and Pfam share a considerable number of switches (4133). This is not surprising, given that both databases overlap to a certain extent.

```{r study_functional_switches-2}

structuralFeatures <- read.delim(paste0(wd,"structural_features.onlyModels.tsv"))

# fix some tags
structuralFeatures$Analysis <- as.character(structuralFeatures$Analysis)
structuralFeatures$Analysis[structuralFeatures$Analysis=="iupred"] <- "IUPRED"
structuralFeatures$Analysis[structuralFeatures$Analysis=="anchor"] <- "ANCHOR"
structuralFeatures$Analysis[structuralFeatures$Analysis=="prosite"] <- "ProSite"

nrStructuralFeatures <- structuralFeatures[structuralFeatures$Random=="NonRandom",]

# count the number of gains and losses per switch
nrStructuralFeatures.switchCounts <- ddply(nrStructuralFeatures,.(Gene,Symbol,nTx,tTx,Analysis),summarize,Gains=sum(grepl("Gained",WhatsHappenning)),Losses=sum(grepl("Lost",WhatsHappenning)),Nothing=sum(grepl("Nothing",WhatsHappenning)))

nrStructuralFeatures.switchCounts <- melt(nrStructuralFeatures.switchCounts,id.vars = 1:5)
nrStructuralFeatures.switchCounts <- nrStructuralFeatures.switchCounts[nrStructuralFeatures.switchCounts$value != 0,]

ggplot() + 
  geom_boxplot(data=nrStructuralFeatures.switchCounts,aes(x=Analysis, y=log10(value), fill=variable)) + 
  smartas_theme() + 
  ylab("log10(#features/switch)") + 
  ggtitle("Number or features affected per switch")

```

For all the studied features, the loss of features is prevalent, specially so in Pfam domains and ProSite patterns. It is surprising the high number of features affected in each switch. In the case of disordered features makes sense, as they are much shorter than e.g. a full domain.

```{r study_functional_switches-3}

# count the number of gains and losses per category
ggplot(data=subset(nrStructuralFeatures,WhatsHappenning!="Nothing"),aes(Analysis,fill=WhatsHappenning)) + 
  geom_bar(position="dodge") + 
  ylab("Counts") +
  smartas_theme() +
  theme(legend.position="bottom") + 
  scale_fill_manual(values=c("#d95f02","#7570b3")) + 
  ggtitle("Number or features affected")

```

The number of features being lost is way higher than the number of them being gained.

```{r study_functional_switches-4}

# compare results vs random
rStructuralFeatures <- structuralFeatures[structuralFeatures$Random=="MostAbundantNRandom",]

rStructuralFeatures.counts <- ddply(rStructuralFeatures,.(Analysis),summarize,Gains=sum(grepl("Gained",WhatsHappenning)),Losses=sum(grepl("Lost",WhatsHappenning)))
nrStructuralFeatures.counts <- ddply(nrStructuralFeatures,.(Analysis),summarize,Gains=sum(grepl("Gained",WhatsHappenning)),Losses=sum(grepl("Lost",WhatsHappenning)))

structuralFeatures.counts <- merge(nrStructuralFeatures.counts,rStructuralFeatures.counts,by="Analysis",suffixes=c("",".random"))

f <- apply(structuralFeatures.counts[,2:5],1,function(x){
  f <- fisher.test(matrix(x,2,2))
  c(p=f$p.value,OR=f$estimate)
})

f <- as.data.frame(t(f))
colnames(f) <- c("p","OR")
f$p[f$p==0] <- 1e-300

structuralFeatures.counts <- cbind(structuralFeatures.counts,f)

kable(structuralFeatures.counts)

ggplot(structuralFeatures.counts,aes(x=OR,y=-log10(p),color=Analysis)) + 
  geom_point() + 
  scale_x_continuous(limits=c(0,2)) +
  smartas_theme() +
  theme(legend.position="bottom") +
  xlab("Odds ratio")

```

We compared with the random switches. Thise random switches were generated assuming the normal isoform is the most abundant in normal tissue, which is usually longer. These switches also tend to lost more features than they lose. Nonetheless, our switches still lose more features than they gain in proportion.

