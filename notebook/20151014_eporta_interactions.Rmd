---
title: "Eduard Porta's interaction study"
author: "HÃ©ctor Climente"
date: "10/14/2015"
output: 
  html_document:
    toc: true
---

```{r environment, include=FALSE }
source("~/SmartAS/Pipeline/scripts/variablesAndFunctions.r")
library(knitr)
library(DT)
results_filepath <- paste0(workingDir,"/structural_analysis/")
wd <- paste0("~/SmartAS/Pipeline/notebook/20151014_eporta_interactions_files/data/")
```

```{r get_files, include=FALSE }
dir.create(wd,recursive=T)

file.copy(Sys.glob(paste0(results_filepath,"EduardPorta-Interactions/report/*")),wd,overwrite = T)
file.copy(paste0(workingDir,"/switches/tables/candidateList_splitByTumor_models_notNoise.txt"),wd,overwrite = T)
file.copy(paste0(workingDir,"/switches/tables/candidateList_allCancers_models_notNoise.txt"),wd,overwrite = T)
file.copy(paste0(workingDir,"/mutations/tables/scoredMEGenes.txt"),wd,overwrite = T)
file.copy(paste0(workingDir,"/Data/TCGA/genesAndTranscripts_splitByGene.txt"),wd,overwrite = T)
```

We will use Eduard's analyses to estimate the effect that an isoform switch might have on the protein-protein interaction network.

# Overview

```{r readTables, cache=TRUE }

candidatesDf <- read.delim(paste0(wd,"candidateList_splitByTumor_models_notNoise.txt"))
candidatesDf_agg <- read.delim(paste0(wd,"candidateList_allCancers_models_notNoise.txt"))
meScore <- read.delim(paste0(wd,"scoredMEGenes.txt"))
genesAndTxs <- read.delim(paste0(wd,"genesAndTranscripts_splitByGene.txt"))

ensemblMapping <- read.delim(paste0(wd,"mapping_ucsc_ensembl.txt"),header=F)
colnames(ensemblMapping) <- c("tx","ENSEMBLProtein")
genesAndTxs <- merge(genesAndTxs,ensemblMapping,all.x = T)

```

## Interactions affected vs the rest

We started performing the standard tests on the switches by tumor type. We divided the switches based on if they affected any interaction (at least one interaction Lost or Switched) or not.

```{r standardTest_affectedInteractions_notAffectedInteractions, cache=TRUE }

for (cancer in cancerTypes){
  
  cat(paste0(cancer,"\n"))

  intxFile <- paste0(wd,cancer,"_switches.txt")
  
  # find max number of columns, because they are concatenated
  no_col <- max(count.fields(intxFile,sep = "\t"))
  
  # read table
  interactions <- read.table(intxFile,header=F,fill=T,col.names=1:no_col)
  intxCols <- paste0("Interaction",1:(no_col-6))
  colnames(interactions) <- c("GeneId","Symbol","Normal_transcript","Tumor_transcript","nIso","tIso",intxCols)
  
  # merge with switch annotation and meScore
  thisCancerCands <- candidatesDf[candidatesDf$Tumor==cancer,]
  interactions <- merge(interactions,thisCancerCands)
  interactions <- merge(interactions,meScore,by.x=c("GeneId","Symbol","Normal_transcript","Tumor_transcript"),by.y=c("Gene","Symbol","nTx","tTx"))
  
  interactions$InteractionsAltered <- colSums(apply(interactions[,intxCols],1,function(x) {grepl("Lost.+",x) | grepl("Switched.+",x)} ))
  interactions$InteractionsKept <- colSums(apply(interactions[,intxCols],1,function(x) {grepl("Kept.+",x) } ))
  
  # split by altering/not-altering interactions
  # Group 1: switches that affect at least one interaction
  # Group 2: switches that affect no interaction
  x <- interactions[interactions$InteractionsAltered > 0,c("GeneId","Normal_transcript","Tumor_transcript")]
  y <- interactions[interactions$InteractionsAltered == 0,c("GeneId","Normal_transcript","Tumor_transcript")]
  
  studyGroups(x,y,interactions)
  
}
```

Summarizing the results, what we observe is:

* In *coad*,*hnsc* and *kirc* (also, although non significantly, in brca, kirp, luad, lusc, thca), the switches that affect an interaction affect a higher number of patients. This suggests that they have a functional implication that makes them more frequent.

* In *coad*,*kirc*,*lusc* (also, although non significantly, in brca,hnsc,thca), there is an enrichment in drivers among the switches that change an interaction. This might be due to the fact that drivers' domains are usually better characterized.

* Surprisingly, there isn't a mutual exclusion between switches and mutations in the genes that change interactions. Maybe switches and mutations cannot achieve the same changes in the PPI network. In any case, it is contradictory with the enrichment in drivers.

## More interactions affected than unaffected

By filtering out those switches where no ENSEMBL id was mapped, we get only the switches that could actually be studied by Eduard. We want to study their properties. Also, we looked for  differences between the group that tend to keep the interactions and those that have them affected i.e. InteractionsLost > InteractionsKept vs. InteractionsLost < InteractionsKept.

```{r standardTest_mostlyAffectingInteractions_mostlyNotAffectingInteractions_onlyMapped, cache=TRUE }

candidatesDf <- read.delim(paste0(wd,"candidateList_splitByTumor_models_notNoise.txt"))
candidatesDf_agg <- read.delim(paste0(wd,"candidateList_allCancers_models_notNoise.txt"))
meScore <- read.delim(paste0(wd,"scoredMEGenes.txt"))

for (cancer in cancerTypes){
  
  cat(paste0(cancer,"\n"))

  intxFile <- paste0(wd,cancer,"_switches.txt")
  
  # find max number of columns, because they are concatenated
  no_col <- max(count.fields(intxFile,sep = "\t"))
  
  # read table
  interactions <- read.table(intxFile,header=F,fill=T,col.names=1:no_col)
  intxCols <- paste0("Interaction",1:(no_col-6))
  colnames(interactions) <- c("GeneId","Symbol","Normal_transcript","Tumor_transcript","nIso","tIso",intxCols)
  
  # filter out cases where the UCSC and ENSP could not be mapped
  interactions <- interactions[interactions$nIso!="" & interactions$tIso!="",]
  
  # merge with switch annotation and meScore
  thisCancerCands <- candidatesDf[candidatesDf$Tumor==cancer,]
  interactions <- merge(interactions,thisCancerCands)
  interactions <- merge(interactions,meScore,by.x=c("GeneId","Symbol","Normal_transcript","Tumor_transcript"),by.y=c("Gene","Symbol","nTx","tTx"))
  
  interactions$InteractionsLost <- colSums(apply(interactions[,intxCols],1,function(x) { grepl("Lost.+",x) } ))
  interactions$InteractionsSwitched <- colSums(apply(interactions[,intxCols],1,function(x) { grepl("Switched.+",x) } ))
  interactions$InteractionsKept <- colSums(apply(interactions[,intxCols],1,function(x) { grepl("Kept.+",x) } ))
  
  # split by altering/not-altering interactions
  # Group 1: switches that affect more interactions than interactions are kept
  # Group 2: switches that keep more interactions that those who are destroyed
  x <- interactions[interactions$InteractionsLost > interactions$InteractionsKept,c("GeneId","Normal_transcript","Tumor_transcript")]
  y <- interactions[interactions$InteractionsLost < interactions$InteractionsKept,c("GeneId","Normal_transcript","Tumor_transcript")]
  
  studyGroups(x,y,interactions)
  
  # plot interactions lost vs interactions kept
  p <- ggplot() + 
    geom_point(data=interactions,aes(InteractionsLost,InteractionsKept,size=NumPatients)) + 
    geom_point(data=subset(interactions,Driver==1),aes(InteractionsLost,InteractionsKept,size=NumPatients),color="red") + 
    xlab("# interactions lost") +
    ylab("# interactions kept") +
    smartas_theme()
  print(p)
  
}
```

In *brca*, *kirc*, *luad* and *lusc* the switches with more interactions kept than lost are usually d1 genes. In many other tumor types we observe this unbalance, although non-significant (hnsc,kich,kirp,prad). We don't observe any other remarkable difference.

## Interactions lost on both sides

The file network_interactions_lost_both_sides.edges contains "information about interactions that are lost from both ends due to isoform switches". I read this as interactions based on domains that are lost on both sides, while only the loss of one was necessary.

```{r interactions_lost_both_sides, cache=TRUE }

# read table
interactions <- read.table(paste0(wd,"network_interactions_lost_both_sides.edges"),header=F)
colnames(interactions) <- c("Gene1","Gene2")

```

# Study of interaction partners

